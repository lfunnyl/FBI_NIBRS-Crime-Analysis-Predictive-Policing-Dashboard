CREATE OR REPLACE TABLE `fbi_nibrs_external.stratejik_personel_analizi` AS

WITH Agency_Stats AS (

    SELECT

        ag.agency_name,

        rs.state_name, -- DÃœZELTME: Eyalet ismi 'rs' tablosundan geliyor

        MAX(ag.total_officers) as total_officers, 

        

        -- Toplam SuÃ§ YÃ¼kÃ¼

        COUNT(inc.incident_id) as total_incidents,

        

        -- Åiddet SuÃ§larÄ±

        COUNT(CASE WHEN ot.crime_against = 'Person' THEN 1 END) as violent_crimes,

        

        -- Gece SuÃ§larÄ±

        COUNT(CASE WHEN inc.incident_hour BETWEEN 22 AND 6 THEN 1 END) as night_crimes,

        

        -- En SÄ±k Ä°ÅŸlenen SuÃ§ (Dominant Crime)

        APPROX_TOP_COUNT(ot.offense_category_name, 1)[OFFSET(0)].value as dominant_crime



    FROM `fbi-crimes-eda.fbi_nibrs_external.dolthub_fbi-nibrs_main_nibrs_incident` inc

    

    -- Agency Tablosu

    JOIN `fbi-crimes-eda.fbi_nibrs_external.dolthub_fbi-nibrs_main_cde_agencies` ag 

        ON inc.agency_id = ag.agency_id AND inc.data_year = ag.data_year

        

    -- EKSÄ°K OLAN BAÄLANTI EKLENDÄ°: Eyalet Ä°simleri

    JOIN `fbi-crimes-eda.fbi_nibrs_external.dolthub_fbi-nibrs_main_ref_state` rs 

        ON ag.state_id = rs.state_id

        

    JOIN `fbi-crimes-eda.fbi_nibrs_external.dolthub_fbi-nibrs_main_nibrs_offense` off_link 

        ON inc.incident_id = off_link.incident_id

    JOIN `fbi-crimes-eda.fbi_nibrs_external.dolthub_fbi-nibrs_main_nibrs_offense_type` ot 

        ON off_link.offense_type_id = ot.offense_type_id

        

    WHERE inc.data_year BETWEEN 2013 AND 2015

    GROUP BY ag.agency_name, rs.state_name

    HAVING total_officers > 0 

)



SELECT

    *,

    -- 1. Ä°ÅŸ YÃ¼kÃ¼ Skoru

    ROUND(total_incidents / total_officers, 1) as workload_score,

    

    -- 2. Risk Skoru

    ROUND(violent_crimes / total_incidents, 2) as violence_ratio,

    

    -- 3. Gece YoÄŸunluÄŸu

    ROUND(night_crimes / total_incidents, 2) as night_ratio,

    

    -- 4. AKILLI Ã–NERÄ° SÄ°STEMÄ°

    CASE 

        WHEN (total_incidents / total_officers) > 50 AND (violent_crimes / total_incidents) > 0.3 

            THEN "ğŸš¨ KIRMIZI ALARM: Taktik Ekip & Ek Personel GÃ¶nder"

            

        WHEN (total_incidents / total_officers) > 50 

            THEN "âš ï¸ Personel Yetersiz: Ä°dari Destek / Atama
